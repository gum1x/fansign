<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Download Fansign</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(to bottom, #1a1a2e, #000000);
      color: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .container {
      width: 90%;
      max-width: 500px;
      background-color: rgba(0, 0, 0, 0.6);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 15px rgba(138, 43, 226, 0.5);
    }
    .header {
      background: linear-gradient(to right, #5b21b6, #7e22ce);
      padding: 16px;
      text-align: center;
      border-bottom: 1px solid rgba(138, 43, 226, 0.3);
    }
    .title {
      margin: 0;
      font-size: 1.5rem;
      background: linear-gradient(to right, #d8b4fe, #f5d0fe);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-weight: bold;
    }
    .content {
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .image-container {
      width: 100%;
      margin-bottom: 16px;
      border: 1px solid rgba(138, 43, 226, 0.3);
      border-radius: 8px;
      overflow: hidden;
    }
    img {
      width: 100%;
      height: auto;
      display: block;
    }
    .instructions {
      margin-top: 16px;
      text-align: center;
      color: #d8b4fe;
      font-size: 0.9rem;
    }
    .button {
      margin-top: 16px;
      background: linear-gradient(to right, #5b21b6, #7e22ce);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      max-width: 300px;
      box-shadow: 0 0 10px rgba(138, 43, 226, 0.3);
      transition: all 0.3s ease;
    }
    .button:hover {
      box-shadow: 0 0 15px rgba(138, 43, 226, 0.5);
      background: linear-gradient(to right, #4c1d95, #6b21a8);
    }
    .button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    .button svg {
      margin-right: 8px;
    }
    .footer {
      padding: 16px;
      text-align: center;
      border-top: 1px solid rgba(138, 43, 226, 0.3);
      background-color: rgba(0, 0, 0, 0.6);
    }
    .manual-instructions {
      margin-top: 16px;
      padding: 12px;
      background-color: rgba(138, 43, 226, 0.1);
      border: 1px solid rgba(138, 43, 226, 0.3);
      border-radius: 8px;
      font-size: 0.9rem;
      display: none;
    }
    .manual-instructions h3 {
      margin-top: 0;
      color: #d8b4fe;
    }
    .manual-instructions ol {
      text-align: left;
      padding-left: 24px;
    }
    .manual-instructions li {
      margin-bottom: 8px;
    }
    .success-message {
      color: #4ade80;
      margin-top: 8px;
      font-size: 0.9rem;
      display: none;
    }
    .error-message {
      color: #f87171;
      margin-top: 8px;
      font-size: 0.9rem;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 class="title">Download Your Fansign</h1>
    </div>
    <div class="content">
      <div id="loading" style="text-align: center;">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="spin" style="margin-bottom: 16px;">
          <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
        </svg>
        <div style="color: #a855f7;">Loading your image...</div>
      </div>
      
      <div id="error-container" style="text-align: center; display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#f87171" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 16px;">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <div id="error-message" style="color: #f87171; font-weight: 500;"></div>
        <p style="color: #d1d5db; margin-top: 8px;">
          The image may have expired or been removed. Please return to the Telegram bot and try again.
        </p>
      </div>
      
      <div id="image-container" class="image-container" style="display: none;">
        <img id="fansign-image" src="/placeholder.svg" alt="Your custom fansign">
      </div>
      
      <p id="success-text" class="instructions" style="display: none;">Your custom fansign is ready to download!</p>
      
      <div id="success-message" class="success-message"></div>
      <div id="error-download-message" class="error-message"></div>
      
      <div id="manual-instructions" class="manual-instructions">
        <h3>Manual Download</h3>
        <p>If automatic download didn't work, try these steps:</p>
        <ol>
          <li>Press and hold on the image above</li>
          <li>Select "Save Image" or "Download Image" from the menu</li>
          <li>Check your device's download folder or photo gallery</li>
        </ol>
        <button id="open-image-button" class="button" style="margin-top: 12px;">
          Open Image in New Tab
        </button>
      </div>
    </div>
    <div class="footer">
      <button id="download-button" class="button" disabled>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Download Image
      </button>
      <p id="help-text" style="font-size: 0.8rem; color: #9ca3af; margin-top: 12px; display: none;">
        If the download doesn't start automatically, try pressing and holding on the image and selecting "Save Image"
      </p>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const imageData = urlParams.get('data');
      
      const loadingElement = document.getElementById('loading');
      const errorContainer = document.getElementById('error-container');
      const errorMessage = document.getElementById('error-message');
      const imageContainer = document.getElementById('image-container');
      const fansignImage = document.getElementById('fansign-image');
      const successText = document.getElementById('success-text');
      const downloadButton = document.getElementById('download-button');
      const helpText = document.getElementById('help-text');
      const successMessage = document.getElementById('success-message');
      const errorDownloadMessage = document.getElementById('error-download-message');
      const manualInstructions = document.getElementById('manual-instructions');
      const openImageButton = document.getElementById('open-image-button');
      
      if (!imageData) {
        loadingElement.style.display = 'none';
        errorContainer.style.display = 'block';
        errorMessage.textContent = 'No image data provided';
        return;
      }
      
      try {
        // Set the image source
        fansignImage.src = imageData;
        
        // When the image is loaded
        fansignImage.onload = function() {
          loadingElement.style.display = 'none';
          imageContainer.style.display = 'block';
          successText.style.display = 'block';
          downloadButton.disabled = false;
          helpText.style.display = 'block';
        };
        
        // If there's an error loading the image
        fansignImage.onerror = function() {
          loadingElement.style.display = 'none';
          errorContainer.style.display = 'block';
          errorMessage.textContent = 'Failed to load image';
        };
        
        // Handle download button click
        downloadButton.addEventListener('click', function() {
          try {
            const link = document.createElement('a');
            link.href = imageData;
            link.download = `fansign-${new Date().getTime()}.jpg`;
            link.setAttribute('download', `fansign-${new Date().getTime()}.jpg`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success message
            successMessage.textContent = 'Download started! If it didn\'t work, try the manual download options below.';
            successMessage.style.display = 'block';
            
            // Show manual instructions after a short delay
            setTimeout(function() {
              manualInstructions.style.display = 'block';
            }, 3000);
          } catch (err) {
            console.error('Download error:', err);
            errorDownloadMessage.textContent = 'Failed to download image automatically. Please try the manual download options.';
            errorDownloadMessage.style.display = 'block';
            manualInstructions.style.display = 'block';
          }
        });
        
        // Handle open image button click
        openImageButton.addEventListener('click', function() {
          const newTab = window.open();
          if (newTab) {
            newTab.document.write(`
              <html>
                <head>
                  <title>Fansign Download</title>
                  <meta name="viewport" content="width=device-width, initial-scale=1.0">
                  <style>
                    body { margin: 0; padding: 20px; text-align: center; background: #000; color: white; font-family: Arial, sans-serif; }
                    img { max-width: 100%; height: auto; margin-bottom: 20px; }
                    p { margin-bottom: 20px; }
                  </style>
                </head>
                <body>
                  <h2>Your Fansign Image</h2>
                  <p>Press and hold on the image below, then select "Save Image"</p>
                  <img src="${imageData}" alt="Your custom fansign">
                  <p>If that doesn't work, take a screenshot of this page.</p>
                </body>
              </html>
            `);
            newTab.document.close();
          } else {
            errorDownloadMessage.textContent = 'Popup blocked. Please allow popups and try again.';
            errorDownloadMessage.style.display = 'block';
          }
        });
        
      } catch (error) {
        loadingElement.style.display = 'none';
        errorContainer.style.display = 'block';
        errorMessage.textContent = 'Error processing image data';
        console.error('Error:', error);
      }
    });
  </script>
  
  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .spin {
      animation: spin 1s linear infinite;
    }
  </style>
</body>
</html>
